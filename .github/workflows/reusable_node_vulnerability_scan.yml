name: Authenticated DAST. Quick Vulnerability Scan with OWASP ZAP Proxy


on:

  workflow_dispatch:


jobs:

  zap-scan:

    runs-on: ubuntu-latest


    steps:

    - name: Checkout code

      uses: actions/checkout@v2


    - name: Set up environment

      run: |

        sudo apt-get update

        sudo apt-get install -y openjdk-8-jre-headless

        pip3 install pytest pytest-xdist

        pip3 install zapcli


    - name: Install OWASP ZAP

      run: |

        wget https://github.com/zaproxy/zaproxy/releases/download/v2.9.0/ZAP_2.9.0_Linux.tar.gz

        tar -xvzf ZAP_2.9.0_Linux.tar.gz

        echo "ZAP_PATH=$PWD/ZAP_2.9.0" >> $GITHUB_ENV


    - name: Start ZAP

      run: |

        AUTH_TOKEN=$(curl -XPOST -H 'Content-Type: application/json' "https://dummyjson.com/auth/login" -d "{\"username\": \"${{ secrets.USERNAME }}\", \"password\":\"${{ secrets.PASSWORD }}\"}" | jq -r ".token")

        echo "ZAP_AUTH_HEADER_VALUE=Bearer\ $AUTH_TOKEN" >> $GITHUB_ENV

        echo "ZAP_AUTH_HEADER=Authorization" >> $GITHUB_ENV

        $ZAP_PATH/zap.sh -daemon -host 0.0.0.0 -port 8090 -config api.disablekey=true &

        sleep 30


    - name: Run ZAP scan

      run: |

        zap-cli -p 8090 status -t 120

        zap-cli -p 8090 quick-scan \

        -s xss,sqli --spider \

        "https://dummyjson.com/"


    - name: Stop ZAP

      run: |

        zap-cli -p 8090 shutdown
